---
// Payment status page - handles redirect from PhonePe
const url = new URL(Astro.request.url);
const searchParams = url.searchParams;

// Get status from URL parameters (PhonePe redirects with these)
const code = searchParams.get('code');
const transactionId = searchParams.get('transactionId');
const merchantOrderId = searchParams.get('merchantOrderId');
const amount = searchParams.get('amount');

// Determine payment status
let status: 'success' | 'failure' | 'pending' | 'unknown' = 'unknown';
let statusMessage = '';

if (code === 'PAYMENT_SUCCESS') {
  status = 'success';
  statusMessage = 'Payment completed successfully!';
} else if (code === 'PAYMENT_ERROR' || code === 'PAYMENT_DECLINED') {
  status = 'failure';
  statusMessage = 'Payment failed. Please try again.';
} else if (code === 'PAYMENT_PENDING') {
  status = 'pending';
  statusMessage = 'Payment is pending. Please wait...';
} else {
  statusMessage = 'Payment status unknown.';
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Status - PhonePe</title>
</head>
<body class="bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 min-h-screen flex items-center justify-center">
  <div class="container mx-auto px-4 py-12">
    <div class="max-w-2xl mx-auto">
      <!-- Status Card -->
      <div class="bg-white rounded-2xl shadow-2xl p-8 md:p-12">
        <!-- Status Icon -->
        <div class="text-center mb-8">
          {status === 'success' && (
            <div class="inline-block p-6 bg-green-100 rounded-full mb-4 animate-bounce">
              <svg class="w-16 h-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          )}
          
          {status === 'failure' && (
            <div class="inline-block p-6 bg-red-100 rounded-full mb-4">
              <svg class="w-16 h-16 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          )}
          
          {status === 'pending' && (
            <div class="inline-block p-6 bg-yellow-100 rounded-full mb-4">
              <svg class="w-16 h-16 text-yellow-600 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
          )}
          
          {status === 'unknown' && (
            <div class="inline-block p-6 bg-gray-100 rounded-full mb-4">
              <svg class="w-16 h-16 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          )}

          <!-- Status Title -->
          <h1 class={`text-3xl md:text-4xl font-bold mb-3 ${
            status === 'success' ? 'text-green-600' :
            status === 'failure' ? 'text-red-600' :
            status === 'pending' ? 'text-yellow-600' :
            'text-gray-600'
          }`}>
            {status === 'success' && 'Payment Successful!'}
            {status === 'failure' && 'Payment Failed'}
            {status === 'pending' && 'Payment Pending'}
            {status === 'unknown' && 'Payment Status Unknown'}
          </h1>
          
          <p class="text-gray-600 text-lg">
            {statusMessage}
          </p>
        </div>

        <!-- Transaction Details -->
        {(merchantOrderId || transactionId || amount) && (
          <div class="bg-gray-50 rounded-xl p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Transaction Details</h2>
            <div class="space-y-3">
              {merchantOrderId && (
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Order ID:</span>
                  <span class="font-mono text-sm font-semibold text-gray-800">{merchantOrderId}</span>
                </div>
              )}
              {transactionId && (
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Transaction ID:</span>
                  <span class="font-mono text-sm font-semibold text-gray-800">{transactionId}</span>
                </div>
              )}
              {amount && (
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Amount:</span>
                  <span class="text-xl font-bold text-gray-800">â‚¹{(parseInt(amount) / 100).toFixed(2)}</span>
                </div>
              )}
              {code && (
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Status Code:</span>
                  <span class="font-mono text-sm font-semibold text-gray-800">{code}</span>
                </div>
              )}
            </div>
          </div>
        )}

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-4">
          {status !== 'success' && (
            <a 
              href="/payment" 
              class="flex-1 py-4 px-6 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold text-center rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all"
            >
              Try Again
            </a>
          )}
          <a 
            href="/" 
            class="flex-1 py-4 px-6 bg-white border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-bold text-center rounded-xl shadow-md hover:shadow-lg transition-all"
          >
            Go to Home
          </a>
        </div>
      </div>

      <!-- Additional Info -->
      {status === 'success' && (
        <div class="mt-8 text-center">
          <p class="text-gray-600">
            A confirmation has been sent. Thank you for your payment!
          </p>
          <p class="text-sm text-gray-500 mt-2">
            Redirecting to home page in 3 seconds...
          </p>
        </div>
      )}
      
      {status === 'failure' && (
        <div class="mt-8 text-center">
          <p class="text-gray-600">
            If you continue to face issues, please contact support.
          </p>
        </div>
      )}
    </div>
  </div>

  <script is:inline define:vars={{ status }}>
    if (status === 'success') {
      setTimeout(() => {
        window.location.href = '/';
      }, 3000);
    }
  </script>

  <style>
    @keyframes bounce {
      0%, 100% {
        transform: translateY(-5%);
        animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
      }
      50% {
        transform: translateY(0);
        animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
      }
    }
    
    .animate-bounce {
      animation: bounce 1s infinite;
    }
  </style>
</body>
</html>
